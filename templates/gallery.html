{% extends "base.html" %}

{% block title %}Gallery - AgenticVisionForge{% endblock %}

{% block extra_head %}
<style>
    .masonry-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        grid-gap: 1.5rem;
        grid-auto-flow: dense;
    }
    
    .masonry-item {
        break-inside: avoid;
        margin-bottom: 1.5rem;
    }
    
    .image-container {
        position: relative;
        padding-top: 100%;
        overflow: hidden;
    }
    
    .image-container img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .image-container:hover img {
        transform: scale(1.05);
    }
    
    .image-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        color: white;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .image-container:hover .image-overlay {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
            Image Gallery
        </h2>
        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Browse and manage your generated images
        </p>
    </div>

    <!-- Filters and Controls -->
    <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex flex-wrap gap-4 items-center">
            <!-- Search -->
            <div class="relative">
                <input
                    type="text"
                    placeholder="Search images..."
                    class="w-64 pl-10 pr-4 py-2 text-sm text-gray-900 bg-white border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>

            <!-- Filter Dropdown -->
            <div class="relative" x-data="{ open: false }">
                <button
                    @click="open = !open"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-4 focus:ring-blue-300 dark:bg-gray-700 dark:text-white dark:border-gray-600 dark:hover:bg-gray-600"
                >
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                        Filter
                    </span>
                </button>
                <div
                    x-show="open"
                    @click.away="open = false"
                    class="absolute z-10 mt-2 w-48 bg-white rounded-lg shadow-lg dark:bg-gray-700"
                >
                    <div class="p-2">
                        <label class="inline-flex items-center p-2 w-full rounded hover:bg-gray-100 dark:hover:bg-gray-600">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-200">Recent First</span>
                        </label>
                        <label class="inline-flex items-center p-2 w-full rounded hover:bg-gray-100 dark:hover:bg-gray-600">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-200">Favorites Only</span>
                        </label>
                        <label class="inline-flex items-center p-2 w-full rounded hover:bg-gray-100 dark:hover:bg-gray-600">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-200">Failed Generations</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="flex rounded-lg border border-gray-300 dark:border-gray-600">
                <button class="px-3 py-2 text-sm font-medium rounded-l-lg bg-gray-100 text-gray-900 dark:bg-gray-600 dark:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                </button>
                <button class="px-3 py-2 text-sm font-medium rounded-r-lg text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM14 13a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Batch Actions -->
        <div class="flex gap-2">
            <button class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300">
                Delete Selected
            </button>
            <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300">
                Download Selected
            </button>
        </div>
    </div>

    <!-- Image Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for image in images %}
        <div class="relative group">
            <div class="aspect-w-1 aspect-h-1 w-full overflow-hidden rounded-lg bg-gray-200 dark:bg-gray-700">
                <img
                    src="{{ image.url }}"
                    alt="{{ image.goal }}"
                    class="h-full w-full object-cover object-center group-hover:opacity-75 transition-opacity duration-300"
                />
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity duration-300"></div>
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <button class="mx-1 p-2 text-white hover:text-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                    <button class="mx-1 p-2 text-white hover:text-yellow-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </button>
                    <button class="mx-1 p-2 text-white hover:text-green-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                    <button class="mx-1 p-2 text-white hover:text-red-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="mt-2">
                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">{{ image.goal }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ image.date }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Empty State -->
    {% if not images %}
    <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No images</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by generating your first image</p>
        <div class="mt-6">
            <a href="/generate" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Generate Image
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Image Modal -->
    <div x-data="{ open: false, image: null }" @keydown.escape="open = false" class="relative z-50">
        <!-- Background overlay -->
        <div x-show="open" class="fixed inset-0 bg-black bg-opacity-75 transition-opacity"></div>

        <!-- Modal -->
        <div x-show="open" class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl sm:p-6">
                    <div class="absolute right-0 top-0 pr-4 pt-4">
                        <button @click="open = false" class="rounded-md bg-white dark:bg-gray-800 text-gray-400 hover:text-gray-500 focus:outline-none">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <img :src="image" class="w-full rounded-lg" />
                            <div class="mt-4">
                                <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-gray-100">Image Details</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        Goal: <span x-text="image?.goal"></span>
                                    </p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        Generated: <span x-text="image?.date"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Image grid masonry layout
document.addEventListener('DOMContentLoaded', function() {
    const grid = document.querySelector('.grid');
    const images = grid.querySelectorAll('img');
    
    images.forEach(img => {
        img.addEventListener('click', function() {
            const modal = document.querySelector('[x-data]').__x.$data;
            modal.image = {
                url: this.src,
                goal: this.alt,
                date: this.closest('.relative').querySelector('.text-gray-500').textContent
            };
            modal.open = true;
        });
    });
});

// Search functionality
const searchInput = document.querySelector('input[type="text"]');
searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const images = document.querySelectorAll('.grid > div');
    
    images.forEach(image => {
        const goal = image.querySelector('.text-gray-900').textContent.toLowerCase();
        if (goal.includes(searchTerm)) {
            image.style.display = '';
        } else {
            image.style.display = 'none';
        }
    });
});

// Batch selection
let selectedImages = new Set();

function toggleImageSelection(imageId) {
    if (selectedImages.has(imageId)) {
        selectedImages.delete(imageId);
    } else {
        selectedImages.add(imageId);
    }
    updateBatchActions();
}

function updateBatchActions() {
    const deleteBtn = document.querySelector('button:contains("Delete Selected")');
    const downloadBtn = document.querySelector('button:contains("Download Selected")');
    
    if (selectedImages.size > 0) {
        deleteBtn.disabled = false;
        downloadBtn.disabled = false;
    } else {
        deleteBtn.disabled = true;
        downloadBtn.disabled = true;
    }
}

// Favorite toggle
function toggleFavorite(imageId) {
    // Implementation for toggling favorite status
}

// Delete image
async function deleteImage(imageId) {
    if (confirm('Are you sure you want to delete this image?')) {
        try {
            const response = await fetch(`/api/images/${imageId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
                imageElement.remove();
                showToast('Image deleted successfully', 'success');
            } else {
                throw new Error('Failed to delete image');
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

// Download image
function downloadImage(imageUrl, filename) {
    const a = document.createElement('a');
    a.href = imageUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %} 