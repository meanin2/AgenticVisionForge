{% extends "base.html" %}

{% block title %}Generate - AgenticVisionForge{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
            Generate Image
        </h2>
        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Describe your vision and let AI bring it to life
        </p>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
        <!-- Generation Form -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <form id="generation-form" class="space-y-6">
                    <!-- Goal Description -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Goal Description
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1">
                            <textarea
                                required
                                rows="4"
                                name="goal"
                                placeholder="Describe the image you want to generate..."
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"
                            ></textarea>
                        </div>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Be as detailed as possible in your description
                        </p>
                    </div>

                    <!-- Advanced Options -->
                    <div x-data="{ open: false }">
                        <button
                            type="button"
                            @click="open = !open"
                            class="flex items-center text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200"
                        >
                            <svg
                                :class="{'rotate-90': open}"
                                class="w-5 h-5 mr-1 transform transition-transform duration-200"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                            Advanced Options
                        </button>

                        <div x-show="open" class="mt-4 space-y-4">
                            <!-- Max Iterations -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Max Iterations
                                </label>
                                <div class="mt-1">
                                    <input
                                        type="number"
                                        name="max_iterations"
                                        min="1"
                                        max="10"
                                        value="3"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"
                                    />
                                </div>
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                    Number of refinement iterations (1-10)
                                </p>
                            </div>

                            <!-- Run Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Run Name
                                </label>
                                <div class="mt-1">
                                    <input
                                        type="text"
                                        name="run_name"
                                        placeholder="Optional custom name for this generation"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"
                                    />
                                </div>
                            </div>

                            <!-- Output Directory -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Output Directory
                                </label>
                                <div class="mt-1">
                                    <input
                                        type="text"
                                        name="output_dir"
                                        placeholder="Optional custom output directory"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div>
                        <button
                            type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span id="submit-text">Generate Image</span>
                            <div id="submit-spinner" class="spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Generation Status -->
        <div class="lg:col-span-1">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">
                    Generation Status
                </h3>

                <!-- Progress -->
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm font-medium text-gray-900 dark:text-gray-100">
                            <span>Overall Progress</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Current Step -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100">
                            Current Step
                        </h4>
                        <p id="current-step" class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Waiting to start...
                        </p>
                    </div>

                    <!-- Latest Preview -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2">
                            Latest Preview
                        </h4>
                        <div id="preview-container" class="aspect-w-1 aspect-h-1 w-full bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden">
                            <div class="flex items-center justify-center text-gray-400 dark:text-gray-500">
                                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentRunId = null;
let ws = null;

// Form submission
document.getElementById('generation-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const submitButton = form.querySelector('button[type="submit"]');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    
    // Disable form and show loading state
    form.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);
    submitText.textContent = 'Generating...';
    submitSpinner.classList.remove('hidden');
    
    try {
        const formData = new FormData(form);
        const response = await fetch('/generate', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to start generation');
        }
        
        currentRunId = data.run_id;
        
        // Connect to WebSocket for real-time updates
        connectWebSocket();
        
        showToast('Generation started successfully', 'success');
        
    } catch (error) {
        showToast(error.message, 'error');
        
        // Re-enable form
        form.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);
        submitText.textContent = 'Generate Image';
        submitSpinner.classList.add('hidden');
    }
});

function connectWebSocket() {
    if (ws) {
        ws.close();
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}/ws/generation/${currentRunId}`);
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateProgress(data);
    };
    
    ws.onerror = function(error) {
        showToast('WebSocket error: ' + error.message, 'error');
    };
    
    ws.onclose = function() {
        if (currentRunId) {
            // Try to reconnect after 5 seconds
            setTimeout(connectWebSocket, 5000);
        }
    };
}

function updateProgress(data) {
    // Update progress bar
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    progressBar.style.width = `${data.progress}%`;
    progressPercentage.textContent = `${data.progress}%`;
    
    // Update current step
    const currentStep = document.getElementById('current-step');
    currentStep.textContent = data.current_step;
    
    // Update preview image if available
    if (data.preview_url) {
        const previewContainer = document.getElementById('preview-container');
        previewContainer.innerHTML = `
            <img
                src="${data.preview_url}"
                alt="Generation preview"
                class="w-full h-full object-cover"
            />
        `;
    }
    
    // Handle completion
    if (data.status === 'completed') {
        currentRunId = null;
        if (ws) {
            ws.close();
        }
        
        // Re-enable form
        const form = document.getElementById('generation-form');
        form.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);
        document.getElementById('submit-text').textContent = 'Generate Image';
        document.getElementById('submit-spinner').classList.add('hidden');
        
        // Show completion message
        showToast('Generation completed successfully', 'success');
        
        // Redirect to results page
        setTimeout(() => {
            window.location.href = `/results/${data.run_name}`;
        }, 1500);
    }
}
</script>
{% endblock %} 