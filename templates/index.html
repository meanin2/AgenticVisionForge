{% extends "base.html" %}

{% block title %}Dashboard - AgenticVisionForge{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
  <!-- Header: Generate New Image -->
  <div class="mb-6">
    <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
      Generate New Image
    </h2>
    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
      Provide a description (goal) for your desired image, then let the AI do the rest.
    </p>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
    <!-- Changed form to post to /create_run instead of / -->
    <form id="create-run-form" action="/create_run" method="POST" class="space-y-6">
      <!-- Goal Description -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
          Goal Description <span class="text-red-500">*</span>
        </label>
        <div class="mt-1">
          <textarea
            required
            rows="4"
            name="goal"
            placeholder="Describe the image you want to generate..."
            class="block w-full rounded-md border-gray-300 shadow-sm
                   focus:border-blue-500 focus:ring-blue-500
                   dark:bg-gray-700 dark:border-gray-600
                   dark:text-white sm:text-sm"
          ></textarea>
        </div>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          Be as detailed as possible for better results.
        </p>
      </div>

      <!-- Advanced Options -->
      <div x-data="{ open: false }">
        <button
          type="button"
          @click="open = !open"
          class="flex items-center text-sm text-gray-600 hover:text-gray-900
                 dark:text-gray-400 dark:hover:text-gray-200"
        >
          <svg
            :class="{'rotate-90': open}"
            class="w-5 h-5 mr-1 transform transition-transform duration-200"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7" />
          </svg>
          Advanced Options
        </button>
        <p class="mt-1 text-xs text-gray-400 dark:text-gray-500" x-show="!open">
          (optional): specify iteration count or custom run name
        </p>
        <div x-show="open" class="mt-4 space-y-4">
          <!-- Max Iterations -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
              Max Iterations
            </label>
            <div class="mt-1">
              <input
                type="number"
                name="max_iterations"
                min="1"
                max="50"
                placeholder="e.g. 10"
                class="block w-full rounded-md border-gray-300
                       shadow-sm focus:border-blue-500 focus:ring-blue-500
                       dark:bg-gray-700 dark:border-gray-600
                       dark:text-white sm:text-sm"
              />
            </div>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
              Number of refinement iterations (1-50)
            </p>
          </div>

          <!-- Run Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
              Run Name
            </label>
            <div class="mt-1">
              <input
                type="text"
                name="run_name"
                placeholder="Optional custom name for this generation"
                class="block w-full rounded-md border-gray-300
                       shadow-sm focus:border-blue-500 focus:ring-blue-500
                       dark:bg-gray-700 dark:border-gray-600
                       dark:text-white sm:text-sm"
              />
            </div>
          </div>

          <!-- Output Directory -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
              Output Directory
            </label>
            <div class="mt-1">
              <input
                type="text"
                name="output_dir"
                placeholder="Optional custom output directory"
                class="block w-full rounded-md border-gray-300
                       shadow-sm focus:border-blue-500 focus:ring-blue-500
                       dark:bg-gray-700 dark:border-gray-600
                       dark:text-white sm:text-sm"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div>
        <button
          type="submit"
          class="w-full flex justify-center py-2 px-4 border border-transparent
                 rounded-md shadow-sm text-sm font-medium text-white
                 bg-blue-600 hover:bg-blue-700 focus:outline-none
                 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="submit-text">Generate Image</span>
          <div id="submit-spinner" class="spinner ml-2 hidden"></div>
        </button>
      </div>
    </form>
  </div>

  <!-- All Runs Table -->
  <div>
    <h2 class="mb-4 text-xl font-semibold text-gray-700 dark:text-gray-200">
      All Runs
    </h2>
    <div class="w-full overflow-hidden rounded-lg shadow-xs">
      <div class="w-full overflow-x-auto">
        <table class="w-full whitespace-no-wrap">
          <thead>
            <tr class="text-xs font-semibold tracking-wide text-left
                       text-gray-500 uppercase border-b dark:border-gray-700
                       bg-gray-50 dark:text-gray-400 dark:bg-gray-800">
              <th class="px-4 py-3">Run Name</th>
              <th class="px-4 py-3">Goal</th>
              <th class="px-4 py-3">Iterations</th>
              <th class="px-4 py-3">Date</th>
              <th class="px-4 py-3">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y dark:divide-gray-700 dark:bg-gray-800">
            {% for run in recent_runs %}
            <tr class="text-gray-700 dark:text-gray-400">
              <td class="px-4 py-3 text-sm">
                <p class="font-semibold">{{ run.name }}</p>
              </td>
              <td class="px-4 py-3 text-sm">
                {{ run.goal|default('No goal set')|truncate(50) }}
              </td>
              <td class="px-4 py-3 text-sm">
                {{ run.iterations }}
              </td>
              <td class="px-4 py-3 text-sm">
                {{ run.timestamp }}
              </td>
              <td class="px-4 py-3 text-sm flex gap-2">
                <a href="{{ url_for('results', run_name=run.name) }}"
                   class="px-3 py-1 text-sm font-medium leading-5 text-white
                          bg-blue-600 rounded-md hover:bg-blue-700
                          focus:outline-none focus:ring btn-animate"
                >
                  View
                </a>
                <button onclick="confirmDelete('{{ run.name }}')"
                        class="px-3 py-1 text-sm font-medium leading-5 text-white
                               bg-red-600 rounded-md hover:bg-red-700
                               focus:outline-none focus:ring btn-animate"
                >
                  Delete
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" 
     class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden"
     x-data="{ runToDelete: null }"
>
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-sm mx-4">
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">
      Confirm Deletion
    </h3>
    <p class="text-gray-500 dark:text-gray-400 mb-4">
      Are you sure you want to delete this run? This action cannot be undone.
    </p>
    <div class="flex justify-end gap-3">
      <button onclick="hideDeleteModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100
                     rounded-md hover:bg-gray-200 focus:outline-none focus:ring
                     dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
      >
        Cancel
      </button>
      <button onclick="deleteRun()"
              class="px-4 py-2 text-sm font-medium text-white bg-red-600
                     rounded-md hover:bg-red-700 focus:outline-none focus:ring"
      >
        Delete
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let runToDelete = null;

// On form submit, we do an immediate fetch to create_run, get run_name, and redirect
document.getElementById('create-run-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = this;
  const submitButton = form.querySelector('button[type="submit"]');
  const submitSpinner = document.getElementById('submit-spinner');
  const submitText = document.getElementById('submit-text');

  // Disable form / show spinner
  submitButton.disabled = true;
  submitSpinner.classList.remove('hidden');
  submitText.textContent = 'Creating Run...';

  try {
    const formData = new FormData(form);
    const response = await fetch(form.action, {
      method: 'POST',
      body: formData
    });
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to create run');
    }

    if (data.run_name) {
      // Immediately redirect to the results page
      window.location.href = `/results/${data.run_name}`;
    } else {
      throw new Error('No run_name returned.');
    }

  } catch (error) {
    showToast('Error: ' + error.message, 'error');
    submitButton.disabled = false;
    submitSpinner.classList.add('hidden');
    submitText.textContent = 'Generate Image';
  }
});

// Confirm & Delete logic for runs
function confirmDelete(runName) {
  runToDelete = runName;
  document.getElementById('deleteModal').classList.remove('hidden');
}

function hideDeleteModal() {
  runToDelete = null;
  document.getElementById('deleteModal').classList.add('hidden');
}

async function deleteRun() {
  if (!runToDelete) return;
  try {
    const response = await fetch(`/runs/${runToDelete}/delete`, { method: 'POST' });
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || 'Failed to delete run');
    }
    hideDeleteModal();
    showToast('Run deleted successfully', 'success');
    setTimeout(() => window.location.reload(), 800);
  } catch (error) {
    showToast(error.message, 'error');
    hideDeleteModal();
  }
}
</script>
{% endblock %}
