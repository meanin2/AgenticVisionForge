{% extends "base.html" %}

{% block title %}Results - AgenticVisionForge{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="mb-6">
    <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
      Generation Results
    </h2>
    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
      Run: {{ run_name }}
    </p>
    {% if goal %}
    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
      <strong>Goal:</strong><br>
      {{ goal|safe|replace('\n', '<br>') }}
    </p>
    {% endif %}
  </div>

  <!-- Progress Bar -->
  <div class="mb-6">
    <div class="flex justify-between mb-1">
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progress</span>
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
        {{ images|length }} / {{ max_iterations }}
      </span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
      <div 
        id="progressBar"
        class="bg-blue-600 h-2.5 rounded-full transition-all"
        style="width: {{ (images|length / max_iterations * 100)|round }}%"
      ></div>
    </div>
  </div>

  <!-- Images Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="imagesGrid">
    {% for image in images %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
      <div class="cursor-pointer"
           onclick="showImageLightbox('{{ url_for('serve_generated_image', run_name=run_name, filename=image) }}', {{ loop.index }})">
        <img src="{{ url_for('serve_generated_image', run_name=run_name, filename=image) }}"
             alt="Iteration {{ loop.index }}"
             class="w-full h-64 object-cover hover:opacity-90 transition-opacity"
        />
      </div>
      <div class="p-4">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
          Iteration {{ loop.index }}
        </h3>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if analysis %}
  <!-- Analysis -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">
      Goal Analysis
    </h3>
    <div class="prose dark:prose-invert max-w-none text-sm text-gray-600 dark:text-gray-400">
      {{ analysis|safe|replace('\n', '<br>') }}
    </div>
  </div>
  {% endif %}
</div>

<!-- Image Lightbox -->
<div id="imageLightbox"
     class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center hidden"
     onclick="hideImageLightbox()">
  <div class="relative max-w-7xl mx-auto p-4 w-full h-full flex items-center justify-center">
    <button onclick="hideImageLightbox()"
            class="absolute top-4 right-4 text-white hover:text-gray-300"
    >
      <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
    <img id="lightboxImage"
         src=""
         alt="Full size image"
         class="max-h-full max-w-full object-contain"
         onclick="event.stopPropagation()"
    />
    <div class="absolute bottom-4 left-0 right-0 text-center text-white text-lg">
      <span id="lightboxCaption"></span>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Once the page loads, check if run has started. If not, start it.
// Then begin polling for updates to show new images.
document.addEventListener('DOMContentLoaded', () => {
  checkIfStartedAndBegin();
});

// Lightbox handling
function showImageLightbox(imageSrc, iteration) {
  const lightbox = document.getElementById('imageLightbox');
  const image = document.getElementById('lightboxImage');
  const caption = document.getElementById('lightboxCaption');
  
  image.src = imageSrc;
  caption.textContent = `Iteration ${iteration}`;
  lightbox.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideImageLightbox() {
  const lightbox = document.getElementById('imageLightbox');
  lightbox.classList.add('hidden');
  document.body.style.overflow = '';
}

// We poll /results/<run_name>/status
// If !started, call /start_run/<run_name>
const runName = "{{ run_name }}";
let isPolling = false;

async function checkIfStartedAndBegin() {
  try {
    const statusResp = await fetch(`/results/${runName}/status`);
    const statusData = await statusResp.json();
    if (statusData.error) {
      showToast(statusData.error, 'error');
      return;
    }
    if (!statusData.started) {
      // Not started, let's call /start_run
      await fetch(`/start_run/${runName}`, { method: 'POST' });
    }
    // Now start polling
    if (!isPolling) {
      isPolling = true;
      pollUpdates();
    }
  } catch (err) {
    console.error(err);
  }
}

async function pollUpdates() {
  if (!isPolling) return;
  try {
    const resp = await fetch(`/results/${runName}/status`);
    const data = await resp.json();
    if (data.error) {
      showToast(data.error, 'error');
      return;
    }
    const { images, done, started } = data;
    if (!started) {
      // Possibly a race condition, wait a bit more
      setTimeout(pollUpdates, 3000);
      return;
    }
    // Update the UI with new images if any
    updateImages(images);
    updateProgressBar(images);

    if (done) {
      // If done, we can finalize or show "Complete!"
      return;
    }
    // Otherwise poll again in 3 seconds
    setTimeout(pollUpdates, 3000);

  } catch (error) {
    console.error('pollUpdates error:', error);
    setTimeout(pollUpdates, 5000);
  }
}

function updateImages(images) {
  // Show images in the #imagesGrid
  const imagesGrid = document.getElementById('imagesGrid');
  const currentCount = imagesGrid.querySelectorAll('img').length;
  if (images.length <= currentCount) {
    return; // no new images
  }

  // Add only the newly arrived images
  for (let i = currentCount; i < images.length; i++) {
    const iterationIndex = i + 1; // 1-based
    const imageFilename = images[i];
    const imageURL = `/runs/${runName}/generations/${imageFilename}`;
    const card = document.createElement('div');
    card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden';

    card.innerHTML = `
      <div class="cursor-pointer" onclick="showImageLightbox('${imageURL}', ${iterationIndex})">
        <img src="${imageURL}"
             alt="Iteration ${iterationIndex}"
             class="w-full h-64 object-cover hover:opacity-90 transition-opacity"
        />
      </div>
      <div class="p-4">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
          Iteration ${iterationIndex}
        </h3>
      </div>
    `;
    imagesGrid.appendChild(card);
  }
}

function updateProgressBar(images) {
  const progressBar = document.getElementById('progressBar');
  const maxIters = {{ max_iterations }};
  const currentCount = images.length;
  const percentage = (currentCount / maxIters) * 100;
  progressBar.style.width = `${percentage.toFixed(1)}%`;
}

</script>
{% endblock %}
