{% extends "base.html" %}

{% block title %}Results - AgenticVisionForge{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="mb-6">
    <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
      Generation Results
    </h2>
    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
      Run: {{ run_name }}
    </p>
    {% if goal %}
    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
      <strong>Goal:</strong><br>
      {{ goal|safe|replace('\n', '<br>')|replace('**', '<strong>')|replace('*', '<em>')|replace('•', '&bull;') }}
    </p>
    {% endif %}
  </div>

  <!-- Progress Bar -->
  <div class="mb-6">
    <div class="flex justify-between mb-1">
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Progress</span>
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
        {{ images|length }} / {{ max_iterations }}
      </span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
      <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ (images|length / max_iterations * 100)|round }}%"></div>
    </div>
  </div>

  <!-- Images Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    {% for image in images %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
      <div class="cursor-pointer" onclick="showImageLightbox('{{ url_for('serve_generated_image', run_name=run_name, filename=image) }}', {{ loop.index }})">
        <img src="{{ url_for('serve_generated_image', run_name=run_name, filename=image) }}"
             alt="Generation {{ loop.index }}"
             class="w-full h-64 object-cover hover:opacity-90 transition-opacity"
        />
      </div>
      <div class="p-4">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
          Iteration {{ loop.index }}
        </h3>
        {% if logs %}
        <button onclick="viewLog('{{ loop.index }}')"
                class="mt-2 px-3 py-1 text-sm font-medium text-blue-600 hover:text-blue-700
                       dark:text-blue-400 dark:hover:text-blue-300"
        >
          View Details
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  {% if analysis %}
  <!-- Analysis -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">
      Goal Analysis
    </h3>
    <div class="prose dark:prose-invert max-w-none text-sm text-gray-600 dark:text-gray-400">
      {{ analysis|safe|replace('\n', '<br>')|replace('**', '<strong>')|replace('*', '<em>')|replace('•', '&bull;') }}
    </div>
  </div>
  {% endif %}
</div>

<!-- Image Lightbox -->
<div id="imageLightbox"
     class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center hidden"
     onclick="hideImageLightbox()"
>
  <div class="relative max-w-7xl mx-auto p-4 w-full h-full flex items-center justify-center">
    <button onclick="hideImageLightbox()"
            class="absolute top-4 right-4 text-white hover:text-gray-300"
    >
      <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
    <img id="lightboxImage"
         src=""
         alt="Full size image"
         class="max-h-full max-w-full object-contain"
         onclick="event.stopPropagation()"
    />
    <div class="absolute bottom-4 left-0 right-0 text-center text-white text-lg">
      <span id="lightboxCaption"></span>
    </div>
  </div>
</div>

<!-- Log Modal -->
<div id="logModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden"
     onclick="hideLogModal()"
>
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
       onclick="event.stopPropagation()"
  >
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
        Iteration Details
      </h3>
      <button onclick="hideLogModal()"
              class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300"
      >
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>
    <div id="logContent"
         class="prose dark:prose-invert max-w-none text-sm text-gray-600 dark:text-gray-400"
    ></div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showImageLightbox(imageSrc, iteration) {
  const lightbox = document.getElementById('imageLightbox');
  const image = document.getElementById('lightboxImage');
  const caption = document.getElementById('lightboxCaption');
  
  image.src = imageSrc;
  caption.textContent = `Iteration ${iteration}`;
  lightbox.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideImageLightbox() {
  const lightbox = document.getElementById('imageLightbox');
  lightbox.classList.add('hidden');
  document.body.style.overflow = '';
}

async function viewLog(iteration) {
  try {
    const response = await fetch(`/runs/{{ run_name }}/iteration_${iteration}.json`);
    if (!response.ok) throw new Error('Failed to load log');
    const data = await response.json();
    
    // Format the log content with markdown-style formatting
    let formattedContent = '';
    if (data.prompt) {
      formattedContent += '<strong>Prompt:</strong><br>' + 
        data.prompt.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>') +
        '<br><br>';
    }
    if (data.analysis) {
      formattedContent += '<strong>Analysis:</strong><br>' +
        data.analysis.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
    }
    
    document.getElementById('logContent').innerHTML = formattedContent;
    document.getElementById('logModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  } catch (error) {
    showToast(error.message, 'error');
  }
}

function hideLogModal() {
  document.getElementById('logModal').classList.add('hidden');
  document.body.style.overflow = '';
}

// Handle ESC key to close modals
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    hideImageLightbox();
    hideLogModal();
  }
});

// Auto-refresh functionality
let isRunning = {% if images|length < max_iterations %}true{% else %}false{% endif %};
const maxIterations = {{ max_iterations }};
const currentIteration = {{ images|length }};

async function checkStatus() {
  if (!isRunning) return;
  
  try {
    const response = await fetch('/results/{{ run_name }}/status');
    const data = await response.json();
    
    if (data.done || data.images.length >= maxIterations) {
      window.location.reload();
      return;
    }
    
    if (data.images.length > currentIteration) {
      window.location.reload();
      return;
    }
    
    setTimeout(checkStatus, 5000); // Check again in 5 seconds
  } catch (error) {
    console.error('Status check failed:', error);
    setTimeout(checkStatus, 5000); // Retry in 5 seconds
  }
}

if (isRunning) {
  checkStatus();
}
</script>
{% endblock %} 