{% extends "base.html" %}

{% block title %}Results - AgenticVisionForge{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- Compact Header -->
  <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">
        Generation Results
        <span class="ml-2 text-sm font-normal text-gray-600 dark:text-gray-400">Run: {{ run_name }}</span>
      </h2>
      <div id="statusIndicator" class="flex items-center">
        <span class="animate-pulse inline-block h-3 w-3 rounded-full bg-green-500 mr-2"></span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Generating...</span>
      </div>
    </div>
    
    <!-- Compact Progress Bar -->
    <div class="mt-3">
      <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-1">
        <span>Progress</span>
        <span>{{ images|length }} of {{ max_iterations }}</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
        <div id="progressBar"
             class="bg-blue-600 h-2 rounded-full transition-all duration-500 ease-in-out"
             style="width: {{ (images|length / max_iterations * 100)|round }}%">
        </div>
      </div>
    </div>
  </div>

  <!-- Image Gallery -->
  <div class="mb-8 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Generation Progress Gallery</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {% for iteration_json in iteration_data|sort(attribute='iteration')|reverse %}
        {% if iteration_json.iteration > 0 %}
          {% set img_filename = "iteration_" ~ iteration_json.iteration ~ ".png" %}
          <div class="relative group">
            <div class="aspect-w-1 aspect-h-1 w-full overflow-hidden rounded-lg bg-gray-50 dark:bg-gray-900">
              <img
                src="{{ url_for('serve_generated_image', run_name=run_name, filename=img_filename) }}"
                alt="Iteration {{ iteration_json.iteration }}"
                class="h-full w-full object-cover object-center cursor-pointer transform transition-all duration-200 group-hover:scale-105"
                onclick="showImageLightbox(this.src, {{ iteration_json.iteration }})"
              />
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity duration-200">
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                  <span class="bg-black bg-opacity-75 text-white px-3 py-1 rounded-full text-sm">
                    Iteration {{ iteration_json.iteration }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- Detailed Information -->
  <div class="space-y-8">
    {% for iteration_json in iteration_data|sort(attribute='iteration')|reverse %}
      {% if iteration_json.iteration > 0 %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
          <div class="p-4">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                Iteration {{ iteration_json.iteration }}
                <span class="ml-2 px-2 py-0.5 text-xs rounded-full
                          {% if loop.first %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                          {% else %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200{% endif %}">
                  {{ "Latest" if loop.first else "Previous" }}
                </span>
              </h3>
            </div>

            <!-- Prompt Used -->
            <div class="mb-4">
              <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Prompt Used
              </h4>
              <pre class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap bg-gray-50 dark:bg-gray-900 p-3 rounded-md">{{ iteration_json.prompt }}</pre>
            </div>

            <!-- Image Description -->
            <div class="mb-4">
              <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                Image Description
              </h4>
              <p class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-900 p-3 rounded-md">{{ iteration_json.image_description }}</p>
            </div>

            <!-- Alignment Analysis -->
            <div class="mb-4">
              <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Alignment Analysis
              </h4>
              <p class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-900 p-3 rounded-md">{{ iteration_json.alignment_analysis }}</p>
            </div>

            <!-- Collapsible Process Details -->
            <div x-data="{ showProcess: false }">
              <button 
                @click="showProcess = !showProcess"
                class="flex items-center justify-between w-full px-4 py-2 text-sm font-medium text-left text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <span class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  View Process Details
                </span>
                <svg 
                  class="w-4 h-4 transform transition-transform duration-200"
                  :class="showProcess ? 'rotate-180' : ''"
                  fill="none" stroke="currentColor" viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>

              <div 
                x-show="showProcess"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                class="mt-4"
              >
                {% if iteration_json.text_interactions or iteration_json.vision_interactions %}
                  <div class="space-y-4 text-xs">
                    {% if iteration_json.text_interactions %}
                      {% for ti in iteration_json.text_interactions %}
                        <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3">
                          <span class="text-blue-600 dark:text-blue-400 font-medium">{{ ti.stage }}</span>
                          <div class="mt-2 space-y-2">
                            <pre class="bg-white dark:bg-gray-800 p-2 rounded-md overflow-x-auto">{{ ti.response }}</pre>
                          </div>
                        </div>
                      {% endfor %}
                    {% endif %}

                    {% if iteration_json.vision_interactions %}
                      {% for vi in iteration_json.vision_interactions %}
                        <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3">
                          <span class="text-purple-600 dark:text-purple-400 font-medium">Vision: {{ vi.stage }}</span>
                          <div class="mt-2 space-y-2">
                            <pre class="bg-white dark:bg-gray-800 p-2 rounded-md overflow-x-auto">{{ vi.response }}</pre>
                          </div>
                        </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>

            {% if iteration_json.next_prompt %}
              <div class="mt-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3">
                <h4 class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                  </svg>
                  Next Iteration Prompt
                </h4>
                <pre class="text-xs text-blue-800 dark:text-blue-200 bg-white/50 dark:bg-gray-800/50 p-2 rounded-md whitespace-pre-wrap">{{ iteration_json.next_prompt }}</pre>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <!-- Goal and Analysis in Collapsible Section -->
  <div x-data="{ showDetails: false }" class="mt-8">
    <button 
      @click="showDetails = !showDetails"
      class="w-full flex items-center justify-between px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200"
    >
      <span class="font-medium text-gray-900 dark:text-gray-100">View Goal and Initial Analysis</span>
      <svg 
        class="w-5 h-5 transform transition-transform duration-200"
        :class="showDetails ? 'rotate-180' : ''"
        fill="none" stroke="currentColor" viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <div 
      x-show="showDetails"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 transform -translate-y-2"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      class="mt-4"
    >
      {% if goal %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Goal</h3>
          <p class="text-gray-700 dark:text-gray-300 whitespace-pre-line">{{ goal|safe }}</p>
        </div>
      {% endif %}

      {% if analysis %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Initial Analysis</h3>
          <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300">
            {{ analysis|safe|replace('\n', '<br>') }}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Enhanced Image Lightbox -->
<div id="imageLightbox"
     class="fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center hidden"
     onclick="hideImageLightbox()">
  <div class="relative max-w-[95vw] max-h-[95vh] mx-auto p-4 flex flex-col items-center">
    <!-- Close button -->
    <button onclick="hideImageLightbox(); event.stopPropagation();"
            class="absolute -top-2 right-2 text-white hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-white rounded-full p-2 z-10 bg-black bg-opacity-50 hover:bg-opacity-75 transition-all duration-200"
            title="Close (Esc)">
      <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <!-- Navigation buttons -->
    <button id="prevImage" onclick="navigateImage(-1); event.stopPropagation();"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-white rounded-full p-2 bg-black bg-opacity-50 hover:bg-opacity-75 transition-all duration-200 hidden">
      <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>
    
    <button id="nextImage" onclick="navigateImage(1); event.stopPropagation();"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-white rounded-full p-2 bg-black bg-opacity-50 hover:bg-opacity-75 transition-all duration-200 hidden">
      <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </button>

    <!-- Image container -->
    <div class="relative w-full h-full flex items-center justify-center">
      <img id="lightboxImage"
           src=""
           alt="Full size image"
           class="max-h-[85vh] max-w-[85vw] object-contain rounded-lg shadow-2xl transition-all duration-300 ease-in-out transform scale-100 hover:scale-105"
           onclick="event.stopPropagation()"
      />
      <div class="absolute bottom-4 left-0 right-0 text-center">
        <div class="inline-flex items-center space-x-4">
          <span id="lightboxCaption" class="bg-black bg-opacity-75 text-white px-6 py-3 rounded-full text-lg font-medium"></span>
          <span id="imageCounter" class="bg-black bg-opacity-75 text-white px-4 py-2 rounded-full text-sm"></span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentImageIndex = 0;
const imageData = [];

document.addEventListener('DOMContentLoaded', () => {
  checkIfStartedAndBegin();
  
  // Handle escape key for lightbox
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideImageLightbox();
    } else if (e.key === 'ArrowLeft') {
      navigateImage(-1);
    } else if (e.key === 'ArrowRight') {
      navigateImage(1);
    }
  });

  // Collect all image data
  const images = document.querySelectorAll('[data-iteration]');
  images.forEach(img => {
    imageData.push({
      src: img.src,
      iteration: img.dataset.iteration
    });
  });
});

function showImageLightbox(imageSrc, iteration) {
  const lightbox = document.getElementById('imageLightbox');
  const image = document.getElementById('lightboxImage');
  const caption = document.getElementById('lightboxCaption');
  const counter = document.getElementById('imageCounter');
  
  // Find current image index
  currentImageIndex = imageData.findIndex(img => img.src === imageSrc);
  
  // Show/hide navigation buttons
  updateNavigationButtons();
  
  image.src = imageSrc;
  caption.textContent = `Iteration ${iteration}`;
  counter.textContent = `${currentImageIndex + 1} / ${imageData.length}`;
  
  lightbox.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  // Add loading state with zoom effect
  image.style.opacity = '0';
  image.style.transform = 'scale(0.95)';
  
  image.onload = () => {
    image.style.opacity = '1';
    image.style.transform = 'scale(1)';
  };
}

function hideImageLightbox() {
  const lightbox = document.getElementById('imageLightbox');
  const image = document.getElementById('lightboxImage');
  
  // Fade out animation
  image.style.opacity = '0';
  image.style.transform = 'scale(0.95)';
  
  setTimeout(() => {
    lightbox.classList.add('hidden');
    document.body.style.overflow = '';
  }, 200);
}

function navigateImage(direction) {
  const newIndex = currentImageIndex + direction;
  if (newIndex >= 0 && newIndex < imageData.length) {
    currentImageIndex = newIndex;
    const { src, iteration } = imageData[currentImageIndex];
    
    // Update image with fade transition
    const image = document.getElementById('lightboxImage');
    image.style.opacity = '0';
    image.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
      image.src = src;
      document.getElementById('lightboxCaption').textContent = `Iteration ${iteration}`;
      document.getElementById('imageCounter').textContent = `${currentImageIndex + 1} / ${imageData.length}`;
      
      image.onload = () => {
        image.style.opacity = '1';
        image.style.transform = 'scale(1)';
      };
      
      updateNavigationButtons();
    }, 200);
  }
}

function updateNavigationButtons() {
  const prevButton = document.getElementById('prevImage');
  const nextButton = document.getElementById('nextImage');
  
  prevButton.classList.toggle('hidden', currentImageIndex === 0);
  nextButton.classList.toggle('hidden', currentImageIndex === imageData.length - 1);
}

const runName = "{{ run_name }}";
let isPolling = false;
let hasCompletedNotification = false;  // Add flag to track if we've shown completion

async function checkIfStartedAndBegin() {
  try {
    const statusResp = await fetch(`/results/${runName}/status`);
    const statusData = await statusResp.json();
    
    if (statusData.error) {
      showToast(statusData.error, 'error');
      return;
    }
    
    // Check if already complete
    if (statusData.done) {
      updateProgressBar(statusData.images);
      updateStatusIndicator(true);
      return;  // Don't start polling if already complete
    }
    
    if (!statusData.started) {
      await fetch(`/start_run/${runName}`, { method: 'POST' });
    }
    
    if (!isPolling) {
      isPolling = true;
      pollUpdates();
    }
  } catch (err) {
    console.error('Error checking run status:', err);
    showToast('Failed to check run status. Please refresh the page.', 'error');
  }
}

async function pollUpdates() {
  if (!isPolling) return;
  
  try {
    const resp = await fetch(`/results/${runName}/status`);
    const data = await resp.json();
    
    if (data.error) {
      showToast(data.error, 'error');
      isPolling = false;
      return;
    }
    
    const { images, done, started } = data;
    
    if (!started) {
      setTimeout(pollUpdates, 3000);
      return;
    }
    
    updateProgressBar(images);
    updateStatusIndicator(done);
    
    if (done && !hasCompletedNotification) {
      hasCompletedNotification = true;  // Set flag to prevent multiple notifications
      showToast('Generation complete!', 'success');
      isPolling = false;  // Stop polling
      return;
    }
    
    if (!done) {
      setTimeout(pollUpdates, 3000);
    }
  } catch (error) {
    console.error('Error polling updates:', error);
    setTimeout(pollUpdates, 5000);
  }
}

function updateProgressBar(images) {
  const progressBar = document.getElementById('progressBar');
  const maxIters = {{ max_iterations }};
  const currentCount = images.length;
  const percentage = (currentCount / maxIters * 100);
  
  progressBar.style.width = `${percentage.toFixed(1)}%`;
  progressBar.style.transition = 'width 0.5s ease-in-out';
}

function updateStatusIndicator(done) {
  const indicator = document.getElementById('statusIndicator');
  
  if (done) {
    indicator.innerHTML = `
      <span class="inline-block h-3 w-3 rounded-full bg-green-500 mr-2"></span>
      <span class="text-sm text-gray-600 dark:text-gray-400">Complete</span>
    `;
  } else {
    indicator.innerHTML = `
      <span class="animate-pulse inline-block h-3 w-3 rounded-full bg-blue-500 mr-2"></span>
      <span class="text-sm text-gray-600 dark:text-gray-400">Generating...</span>
    `;
  }
}

function showToast(message, type = 'info') {
  // Create toast container if it doesn't exist
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'fixed bottom-4 right-4 z-50 space-y-2';
    document.body.appendChild(container);
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.className = `
    px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 
    ${type === 'error' ? 'bg-red-500 text-white' : 
      type === 'success' ? 'bg-green-500 text-white' : 
      'bg-blue-500 text-white'}
  `;
  toast.textContent = message;
  
  // Add to container
  container.appendChild(toast);
  
  // Animate in
  requestAnimationFrame(() => {
    toast.style.transform = 'translateY(-10px)';
    toast.style.opacity = '1';
  });
  
  // Remove after delay
  setTimeout(() => {
    toast.style.transform = 'translateY(10px)';
    toast.style.opacity = '0';
    setTimeout(() => {
      container.removeChild(toast);
      if (container.children.length === 0) {
        document.body.removeChild(container);
      }
    }, 300);
  }, 3000);
}
</script>
{% endblock %}
